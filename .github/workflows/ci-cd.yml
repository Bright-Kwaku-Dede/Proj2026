# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/proj2026
      APP_PORT: 3000

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Lint the code
      - name: Run ESLint
        run: npx eslint . --max-warnings=0

      # 5Ô∏è‚É£ Run tests
      - name: Run tests
        run: npm test

      # 6Ô∏è‚É£ Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 7Ô∏è‚É£ Log in to GHCR
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 8Ô∏è‚É£ Build Docker image
      - name: Build Docker image
        uses: docker/build-push-action@v5
        id: docker_build
        with:
          context: .
          file: Dockerfile
          push: false
          tags: |
            ${{ env.IMAGE_NAME }}:main
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 9Ô∏è‚É£ Run container and health check
      - name: Run container for health check
  run: |
    docker run -d --name proj2026-test -p 3000:3000 proj2026:local
    # Wait for container to become healthy
    timeout=30
    while [ $timeout -gt 0 ]; do
      status=$(docker inspect --format='{{.State.Health.Status}}' proj2026-test)
      echo "Container health: $status"
      if [ "$status" == "healthy" ]; then
        break
      fi
      sleep 2
      timeout=$((timeout - 2))
    done
    if [ "$status" != "healthy" ]; then
      docker logs proj2026-test
      exit 1
    fi
    - name: Stop test container
  run: docker stop proj2026-test && docker rm proj2026-test


      # üîü Push Docker image to GHCR
      - name: Push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:main
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
